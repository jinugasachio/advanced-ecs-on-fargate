name: Renovate terraform

on: [push, pull_request]

jobs:  
  update-terraform-version:
    name: Update terraform version
    runs-on: ubuntu-latest
    if: startsWith(github.head_ref, 'renovate-terraform')
    permissions: # https://docs.github.com/ja/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token
      id-token: write # IDトークンの取得に必要な情報を環境変数に設定してもらえる。具体的にはConfigure AWS credentialsのwith内のとこ。

    steps: 
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0 # Number of commits to fetch. 0 indicates all history for all branches and tags. Default: 1

      - name: Detect terraform version
        run: printf "TF_VERSION=%s" $(cat .terraform-version) >> $GITHUB_ENV
      
      - name: Setup terraform
        uses: hashicorp/setup-terraform@v1 # https://github.com/hashicorp/setup-terraform
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Install tfnotify
        run: ./scripts/install.sh

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1 # https://github.com/aws-actions/configure-aws-credentials
        with:
          role-to-assume: ${{ secrets.ARN_TO_ASSUME_ROLE }}
          role-session-name: GitHubActions
          aws-region: us-west-2 # オレゴン

      - name: Confirm AWS credentials
        run: aws sts get-caller-identity

      - name: Terraform plan with tfnotify
        run: ./scripts/github_action/plan.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token

  # update-terraform-provider
